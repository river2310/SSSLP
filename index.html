<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo CLUES</title>
    
    <link rel="icon" type="image/png" href="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/favicons/logo-verde.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f4f8;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        #map {
            height: 600px;
            border-radius: 0.5rem;
            z-index: 0;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            z-index: 50;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 600px;
        }
        @keyframes custom-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .animate-custom-pulse {
            animation: custom-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes float-arrow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float-arrow {
            animation: float-arrow 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQjbzFt4pmSA-WFGGjY527FzN81qjhgWKC7KVfKllt-qHjYt6rtOHRoseOhxa0qkcIvsRT6noCc9YIJ/pub?gid=0&single=true&output=csv';
        const RESOURCES_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSxlP3IcVl4224XrW67L8AbTP3zlH5WzK4sC4PRMNQmOMtiP7ZEzNZ7me7XtBL66dKDBwSYPtqwS4fH/pub?gid=0&single=true&output=csv';
        
        const StatCard = ({ title, value, icon }) => (
            <div className="bg-white p-4 rounded-lg shadow-md flex items-center">
                <div className="bg-[#055A1C]/10 text-[#055A1C] p-3 rounded-full mr-4 shrink-0">
                    {icon}
                </div>
                <div className="min-w-0">
                    <p className="text-[10px] md:text-xs font-semibold text-gray-500 uppercase tracking-wider truncate">{title}</p>
                    <p className="text-xl md:text-2xl font-bold text-gray-800">{value}</p>
                </div>
            </div>
        );

        const ContactCard = ({ name, position, email, initials }) => (
            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center space-x-4 hover:shadow-md transition-shadow duration-300">
                <div className="flex-shrink-0 w-12 h-12 bg-[#055A1C] rounded-full flex items-center justify-center text-white font-bold text-lg">
                    {initials}
                </div>
                <div className="flex-grow text-left min-w-0">
                    <h3 className="text-sm md:text-base font-bold text-gray-800 truncate">{name}</h3>
                    <p className="text-[11px] md:text-xs text-gray-500 font-medium leading-tight mb-1">{position}</p>
                    <div className="flex items-center text-[#055A1C] hover:text-[#e6007e] transition-colors">
                        <svg className="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <a href={`mailto:${email}`} className="text-[11px] md:text-xs font-semibold truncate underline decoration-[#055A1C]/20 underline-offset-2">
                            {email}
                        </a>
                    </div>
                </div>
            </div>
        );

        const MapView = ({ data, resources, onMarkerClick }) => {
            const mapRef = React.useRef(null);
            const markerLayerRef = React.useRef(null);
            const markerIconRef = React.useRef(null);

            React.useEffect(() => {
                if (!mapRef.current) {
                    const osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    });
                    
                    const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3'],
                        attribution: 'Map data &copy;2025 Google'
                    });
                    
                    const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EA4335" width="40px" height="40px">
                        <path stroke="#c5221f" stroke-width="1" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        <circle cx="12" cy="9" r="2.5" fill="#752f2f"/>
                        </svg>`;
                    const iconUrl = `data:image/svg+xml;base64,${btoa(svgIcon)}`;

                    markerIconRef.current = new L.Icon({
                        iconUrl: iconUrl,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40] 
                    });

                    mapRef.current = L.map('map', {
                        center: [22.15, -100.98],
                        zoom: 8,
                        layers: [osmStandard]
                    });

                    L.control.layers({
                        "Vista Normal": osmStandard,
                        "Satélite": googleHybrid
                    }).addTo(mapRef.current);
                }
            }, []);

            React.useEffect(() => {
                if (markerLayerRef.current) {
                    mapRef.current.removeLayer(markerLayerRef.current);
                }

                if (data && markerIconRef.current) { 
                    const markerCluster = L.markerClusterGroup({ zoomToBoundsOnClick: true });
                    
                    data.forEach(item => {
                        const lat = parseFloat(item.LATITUD);
                        const lng = parseFloat(item.LONGITUD);
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const marker = L.marker([lat, lng], { icon: markerIconRef.current });
                            marker.on('click', () => {
                                const resourceData = resources.get(item.CLUES.trim()) || {};
                                onMarkerClick({ ...item, ...resourceData });
                            });
                            markerCluster.addLayer(marker);
                        }
                    });
                    
                    mapRef.current.addLayer(markerCluster);
                    markerLayerRef.current = markerCluster;
                    
                    if (markerCluster.getBounds().isValid()) {
                        mapRef.current.fitBounds(markerCluster.getBounds(), { padding: [30, 30], maxZoom: 16 });
                    }
                }
            }, [data, resources, onMarkerClick]);

            return <div id="map" className="shadow-lg"></div>;
        };

        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = React.useRef(null);
            const chartRef = React.useRef(null);

            React.useEffect(() => {
                if (chartRef.current) chartRef.current.destroy();
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, { type, data, options });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, options]);

            return <div className="chart-container"><canvas ref={canvasRef}></canvas></div>;
        };

        const ReportModal = ({ data, onClose }) => {
            const [isResourcesVisible, setIsResourcesVisible] = React.useState(false);
            const [loadingLocation, setLoadingLocation] = React.useState(false);
            const [locationError, setLocationError] = React.useState(null);

            const formatAddressPart = (value, suffix = '') => {
                if (!value || value.toUpperCase() === 'NO ESPECIFICADO' || value.toUpperCase() === 'SIN DATO' || value.trim() === '') return null;
                const cleanedValue = value.trim();
                return cleanedValue.endsWith(suffix) && suffix !== '' ? cleanedValue : cleanedValue + suffix;
            };

            const addressParts = [
                formatAddressPart(data['TIPO DE VIALIDAD']),
                formatAddressPart(data['VIALIDAD']),
                formatAddressPart(data['NUMERO EXTERIOR'], ','),
                formatAddressPart(data['NUMERO INTERIOR']),
                formatAddressPart(data['TIPO DE ASENTAMIENTO']),
                formatAddressPart(data['ASENTAMIENTO'], ','),
                data['CODIGO POSTAL'] ? `C.P. ${data['CODIGO POSTAL']}` : null
            ];

            const fullAddress = addressParts.filter(part => part).join(' ');
            const streetViewEmbedUrl = `https://www.google.com/maps?layer=c&cbll=${data.LATITUD},${data.LONGITUD}&cbp=12,0,0,0,0&output=svembed`;

            const handleGetDirections = () => {
                if (!navigator.geolocation) {
                    setLocationError("Geolocalización no soportada.");
                    return;
                }
                setLoadingLocation(true);
                setLocationError(null);
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        setLoadingLocation(false);
                        window.open(`https://www.google.com/maps/dir/?api=1&origin=${position.coords.latitude},${position.coords.longitude}&destination=${data.LATITUD},${data.LONGITUD}`, '_blank');
                    },
                    (error) => {
                        setLoadingLocation(false);
                        setLocationError("No se pudo obtener ubicación.");
                    }
                );
            };

            return (
                <div className="modal-backdrop" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-[#055A1C]">{data['NOMBRE DE LA UNIDAD']}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl transition-colors">&times;</button>
                        </div>
                        <div className="text-sm space-y-2">
                            <p><strong>CLUES:</strong> {data['CLUES']}</p>
                            <p><strong>Institución:</strong> {data['NOMBRE DE LA INSTITUCION']}</p>
                            <p><strong>Tipo:</strong> {data['NOMBRE TIPO ESTABLECIMIENTO']}</p>
                            <p><strong>Municipio:</strong> {data['MUNICIPIO']}</p>
                            <p><strong>Domicilio:</strong> {fullAddress || 'No especificado'}</p>
                            <hr className="my-3" />
                            <div className="flex justify-between items-center">
                                <h3 className="text-lg font-semibold text-[#055A1C]">Recursos de la Unidad</h3>
                                <button onClick={() => setIsResourcesVisible(!isResourcesVisible)} className="text-sm text-[#055A1C] hover:text-[#e6007e] font-semibold transition-colors">
                                    {isResourcesVisible ? 'Ocultar' : 'Mostrar'}
                                </button>
                            </div>
                            {isResourcesVisible && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 mt-2 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                    <div className="space-y-1">
                                        <p><strong>Cons. Med. General:</strong> {data['CONS_MG'] || "0"}</p>
                                        <p><strong>Cons. Dentales:</strong> {data['CONS_ODONT'] || "0"}</p>
                                        <p><strong>Cons. Especialidades:</strong> {data['CONS_ESP'] || "0"}</p>
                                        <p><strong>Hospitalización:</strong> {data['AREA_HOSP'] || "0"}</p>
                                        <p><strong>Área de Urgencias:</strong> {data['AREA_URGENCIAS'] || "0"}</p>
                                    </div>
                                    <div className="space-y-1">
                                        <p><strong>Hemodiálisis:</strong> {data['HEMOD'] || "0"}</p>
                                        <p><strong>Laboratorio Clínico:</strong> {data['LABORATORIO'] || "0"}</p>
                                        <p><strong>Médicos Generales:</strong> {data['MEDICOS_GENERALES'] || "0"}</p>
                                        <p><strong>Médicos Especialistas:</strong> {data['MEDICOS_ESP'] || "0"}</p>
                                        <p><strong>Enfermeras:</strong> {data['ENFERMERAS'] || "0"}</p>
                                    </div>
                                </div>
                            )}
                            <hr className="my-3" />
                            <iframe className="mt-2 w-full h-60 rounded border-0" loading="lazy" allowFullScreen src={streetViewEmbedUrl}></iframe>
                            {locationError && <p className="text-[10px] text-red-500 mt-2 text-center">{locationError}</p>}
                        </div>
                        <div className="flex justify-end items-center mt-6 space-x-3">
                            <button onClick={handleGetDirections} disabled={loadingLocation} className="px-4 py-2 bg-[#055A1C] text-white rounded-md hover:bg-[#e6007e] font-semibold transition-all duration-200 flex items-center disabled:bg-gray-400 shadow-sm">
                                {loadingLocation ? 'Calculando...' : 'Obtener Ruta'}
                            </button>
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-[#e6007e] hover:text-white font-semibold transition-all duration-200">Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const OnboardingGuide = ({ onDismiss }) => {
            return (
                <div className="fixed inset-0 z-[100] bg-black/70 flex flex-col items-center justify-start pointer-events-auto overflow-hidden">
                    <div className="absolute top-[180px] left-[5%] md:left-[10%] flex flex-col items-center z-10">
                        <div className="animate-float-arrow text-white mb-2">
                            <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                            </svg>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-2xl max-w-[180px] text-center">
                            <h4 className="text-[10px] font-bold text-[#e6007e] uppercase mb-1">Buscador Inteligente</h4>
                            <p className="text-[11px] text-gray-700 leading-tight">Encuentra una unidad rápido tecleando su <b>Nombre</b> o clave <b>CLUES</b>.</p>
                        </div>
                    </div>

                    <div className="absolute top-[180px] left-[35%] md:left-[35%] flex flex-col items-center z-10">
                        <div className="animate-float-arrow text-white mb-2">
                            <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                            </svg>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-2xl max-w-[180px] text-center">
                            <h4 className="text-[10px] font-bold text-[#055A1C] uppercase mb-1">Filtros Dinámicos</h4>
                            <p className="text-[11px] text-gray-700 leading-tight">Segmenta el catálogo por <b>Institución</b> o <b>Municipio</b> específico.</p>
                        </div>
                    </div>

                    <div className="absolute top-[180px] right-[5%] md:right-[5%] flex flex-col items-center z-10">
                        <div className="animate-float-arrow text-white mb-2">
                            <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                            </svg>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-2xl max-w-[180px] text-center">
                            <h4 className="text-[10px] font-bold text-[#055A1C] uppercase mb-1">Exportar Datos</h4>
                            <p className="text-[11px] text-gray-700 leading-tight">Descarga toda la información filtrada en formato <b>Excel (CSV)</b>.</p>
                        </div>
                    </div>

                    <div className="mt-[420px] bg-white p-8 rounded-3xl shadow-2xl max-w-md text-center mx-4 border-t-8 border-[#055A1C]">
                        <div className="flex justify-center mb-4">
                            <img src="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/favicons/logo-verde.png" className="h-12" alt="Logo" />
                        </div>
                        <h2 className="text-2xl font-black text-gray-800 mb-2">Guía de Inicio</h2>
                        <p className="text-sm text-gray-600 mb-8 px-4 leading-relaxed">
                            Bienvenido a la plataforma interactiva del Catálogo CLUES. Utiliza las herramientas señaladas para una mejor experiencia.
                        </p>
                        <button 
                            onClick={onDismiss}
                            className="bg-[#055A1C] text-white w-full py-4 rounded-2xl font-bold hover:bg-[#e6007e] transition-all duration-300 shadow-xl flex items-center justify-center gap-2 group"
                        >
                            ¡Entendido!
                            <svg className="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [allData, setAllData] = React.useState([]);
            const [filteredData, setFilteredData] = React.useState([]);
            const [resources, setResources] = React.useState(new Map());
            const [loading, setLoading] = React.useState(true);
            const [showGuide, setShowGuide] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [modalData, setModalData] = React.useState(null);
            const [suggestions, setSuggestions] = React.useState([]);
            const [filters, setFilters] = React.useState({ search: '', institution: 'TODAS', municipality: 'TODOS' });
            
            const searchContainerRef = React.useRef(null);

            React.useEffect(() => {
                Promise.all([d3.csv(DATA_URL), d3.csv(RESOURCES_DATA_URL)])
                    .then(([data, resData]) => {
                        setAllData(data);
                        setFilteredData(data);
                        setResources(new Map(resData.map(item => [item.CLUES ? item.CLUES.trim() : '', item])));
                        setLoading(false);
                        setTimeout(() => setShowGuide(true), 1200);
                    }).catch(() => {
                        setError("Error cargando la base de datos.");
                        setLoading(false);
                    });
            }, []);

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (searchContainerRef.current && !searchContainerRef.current.contains(event.target)) {
                        setSuggestions(prev => prev.length > 0 ? [] : prev);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            React.useEffect(() => {
                let data = allData;
                if (filters.search) {
                    const s = filters.search.toLowerCase();
                    data = data.filter(d => d['CLUES']?.toLowerCase().includes(s) || d['NOMBRE DE LA UNIDAD']?.toLowerCase().includes(s));
                }
                if (filters.institution !== 'TODAS') data = data.filter(d => d['NOMBRE DE LA INSTITUCION'] === filters.institution);
                if (filters.municipality !== 'TODOS') data = data.filter(d => d['MUNICIPIO'] === filters.municipality);
                setFilteredData(data);
            }, [filters, allData]);

            const uniqueInstitutions = React.useMemo(() => {
                const map = new Map();
                allData.forEach(d => { if (!map.has(d['NOMBRE DE LA INSTITUCION'])) map.set(d['NOMBRE DE LA INSTITUCION'], d['CLAVE DE LA INSTITUCION']); });
                return [{ name: 'TODAS', key: 'TODAS' }, ...Array.from(map.entries()).map(([n, k]) => ({ name: n, key: k !== 'NO ESPECIFICADO' ? `${k} - ${n}` : n })).sort((a,b) => a.key.localeCompare(b.key))];
            }, [allData]);

            const uniqueMunicipalities = React.useMemo(() => ['TODOS', ...Array.from(new Set(allData.map(d => d['MUNICIPIO']))).sort()], [allData]);

            const stats = React.useMemo(() => ({
                municipios: new Set(filteredData.map(d => d['MUNICIPIO'])).size,
                instituciones: new Set(filteredData.map(d => d['NOMBRE DE LA INSTITUCION'])).size
            }), [filteredData]);

            const chartOptions = React.useMemo(() => ({
                doughnut: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', align: 'start', labels: { boxWidth: 10, font: { size: 10 }, textAlign: 'left' } } } },
                bar: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { display: false }, ticks: { font: { size: 10 } } } } }
            }), []);

            const institutionChartData = React.useMemo(() => {
                const counts = filteredData.reduce((acc, d) => {
                    const key = d['CLAVE DE LA INSTITUCION'] !== 'NO ESPECIFICADO' ? `${d['CLAVE DE LA INSTITUCION']} - ${d['NOMBRE DE LA INSTITUCION']}` : d['NOMBRE DE LA INSTITUCION'];
                    acc[key] = (acc[key] || 0) + 1; return acc;
                }, {});
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                return { labels: sorted.map(d => d[0]), datasets: [{ label: 'Unidades', data: sorted.map(d => d[1]), backgroundColor: ['#055A1C', '#055A1CBB', '#055A1C99', '#055A1C77'], hoverBackgroundColor: '#e6007e' }] };
            }, [filteredData]);

            const topMunicipalitiesData = React.useMemo(() => {
                const counts = filteredData.reduce((acc, item) => {
                    const mun = item['MUNICIPIO'] || "No especificado";
                    acc[mun] = (acc[mun] || 0) + 1; return acc;
                }, {});
                const sorted = Object.entries(counts).sort(([, a], [, b]) => b - a).slice(0, 10);
                return { labels: sorted.map(d => d[0]), datasets: [{ label: 'Unidades', data: sorted.map(d => d[1]), backgroundColor: '#055A1C', hoverBackgroundColor: '#e6007e', borderRadius: 4 }] };
            }, [filteredData]);

            const handleSearchChange = (e) => {
                const v = e.target.value;
                setFilters({ ...filters, search: v });
                if (v.length > 2) {
                    const s = v.toLowerCase();
                    setSuggestions(allData.filter(d => d['NOMBRE DE LA UNIDAD']?.toLowerCase().includes(s) || d['CLUES']?.toLowerCase().includes(s)).map(d => d['NOMBRE DE LA UNIDAD']).filter((x, i, a) => a.indexOf(x) === i).slice(0, 7));
                } else setSuggestions([]);
            };

            const downloadCSV = () => {
                if (filteredData.length === 0) return;
                const baseHeaders = Object.keys(allData[0] || {});
                const resHeaders = resources.size > 0 ? Object.keys(resources.values().next().value || {}).filter(h => h !== 'CLUES') : [];
                const allHeaders = [...baseHeaders, ...resHeaders];
                let csv = "\uFEFF" + allHeaders.map(h => `"${h}"`).join(",") + "\r\n";
                filteredData.forEach(row => {
                    const res = resources.get(row.CLUES ? row.CLUES.trim() : '') || {};
                    const combined = { ...row, ...res };
                    csv += allHeaders.map(h => `"${(combined[h] || "").toString().replace(/"/g, '""')}"`).join(",") + "\r\n";
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "catalogo_clues_slp.csv";
                link.click();
            };

            if (loading) return (
                <div className="flex flex-col justify-center items-center h-screen bg-gray-50 space-y-6">
                    <div className="relative flex items-center justify-center">
                        <div className="w-28 h-28 border-4 border-gray-200 border-t-[#055A1C] rounded-full animate-spin"></div>
                        <div className="absolute"><img src="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/favicons/logo-verde.png" alt="Logo" className="w-16 h-16 animate-custom-pulse"/></div>
                    </div>
                    <div className="text-center"><h2 className="text-xl font-bold text-gray-700 tracking-tight">Cargando Catálogo</h2><p className="text-sm text-gray-500 font-medium animate-pulse">Sincronizando registros...</p></div>
                </div>
            );

            if (error) return <div className="flex justify-center items-center h-screen bg-gray-50 p-6 text-center text-red-600 font-bold">{error}</div>;

            return (
                <div className="flex flex-col min-h-screen">
                    {showGuide && <OnboardingGuide onDismiss={() => setShowGuide(false)} />}
                    
                    <header className="bg-white shadow-md sticky top-0 z-10 p-4">
                        <div className="container mx-auto flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                            <div className="flex items-center"><img src="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/hor-verde.png" alt="Logo" className="h-10 mr-4" /><h1 className="text-xl md:text-2xl font-bold text-[#055A1C]">Catálogo CLUES</h1></div>
                            <div className="text-left md:text-right border-t md:border-t-0 md:border-l border-gray-100 pt-2 md:pt-0 md:pl-4">
                                <p className="text-[12px] md:text-sm font-bold text-gray-700 uppercase leading-tight tracking-tight">DIRECCIÓN DE PLANEACIÓN, EVALUACIÓN Y PROYECTOS ESPECIALES</p>
                                <p className="text-[10px] md:text-xs font-medium text-gray-500 uppercase mt-0.5 tracking-tight">SUBDIRECCIÓN DE INFORMÁTICA Y ESTADISTICAS EN SALUD</p>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 lg:p-6 flex-grow">
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-[11px] md:text-sm text-yellow-800 shadow-sm rounded-r-lg">
                            <p className="text-justify italic">La transferencia al Organismo Público Descentralizado IMSS-BIENESTAR aplica exclusivamente a las Unidades Médicas provenientes de los Servicios de Salud de San Luis Potosí.</p>
                        </div>

                        <div id="filter-bar" className="bg-white p-4 rounded-lg shadow-md mb-6 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div className="relative" ref={searchContainerRef}>
                                <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Buscar Unidad</label>
                                <input type="text" placeholder="Nombre o CLUES..." value={filters.search} onChange={handleSearchChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-[#055A1C] focus:outline-none text-sm" />
                                {suggestions.length > 0 && (
                                    <ul className="absolute z-20 w-full bg-white border border-gray-200 rounded-md mt-1 max-h-60 overflow-y-auto shadow-xl">
                                        {suggestions.map((s, i) => <li key={i} onClick={() => { setFilters({ ...filters, search: s }); setSuggestions([]); }} className="p-2 text-sm hover:bg-[#e6007e] hover:text-white cursor-pointer truncate transition-colors font-medium">{s}</li>)}
                                    </ul>
                                )}
                            </div>
                            <div id="inst-filter">
                                <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Institución</label>
                                <select value={filters.institution} onChange={e => setFilters({...filters, institution: e.target.value})} className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-[#055A1C] outline-none">{uniqueInstitutions.map(i => <option key={i.key} value={i.name}>{i.key}</option>)}</select>
                            </div>
                            <div id="mun-filter">
                                <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Municipio</label>
                                <select value={filters.municipality} onChange={e => setFilters({...filters, municipality: e.target.value})} className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-[#055A1C] outline-none">{uniqueMunicipalities.map(m => <option key={m} value={m}>{m}</option>)}</select>
                            </div>
                            <button onClick={() => setFilters({search: '', institution: 'TODAS', municipality: 'TODOS'})} className="bg-gray-200 p-2 rounded hover:bg-[#e6007e] hover:text-white transition-colors font-bold text-sm h-[38px]">Limpiar</button>
                            <button id="download-btn" onClick={downloadCSV} className="bg-[#055A1C] text-white p-2 rounded hover:bg-[#e6007e] transition-colors flex items-center justify-center gap-2 font-bold text-sm h-[38px]">Descargar Catálogo</button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <StatCard title="Total Unidades" value={allData.length} icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>} />
                            <StatCard title="Filtradas" value={filteredData.length} icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>} />
                            <StatCard title="Municipios" value={stats.municipios} icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>} />
                            <StatCard title="Instituciones" value={stats.instituciones} icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" /></svg>} />
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 bg-white p-4 rounded-lg shadow-md"><MapView data={filteredData} resources={resources} onMarkerClick={setModalData} /></div>
                            <div className="flex flex-col gap-6">
                                <div className="bg-white p-4 rounded-lg shadow-md"><h2 className="font-bold mb-4 text-xs uppercase text-gray-500 tracking-wider">Instituciones</h2><ChartComponent type="doughnut" data={institutionChartData} options={chartOptions.doughnut} /></div>
                                <div className="bg-white p-4 rounded-lg shadow-md"><h2 className="font-bold mb-4 text-xs uppercase text-gray-500 tracking-wider">Top 10 Municipios</h2><ChartComponent type="bar" data={topMunicipalitiesData} options={chartOptions.bar} /></div>
                            </div>
                        </div>
                    </main>

                    <footer className="bg-[#f8fafc] border-t border-gray-200 py-12 mt-12">
                        <div className="container mx-auto px-4 text-center">
                            <p className="text-[10px] md:text-xs text-gray-400 mb-10 uppercase tracking-widest font-semibold tracking-tighter">Versión de datos: Octubre 2025</p>
                            <div className="max-w-4xl mx-auto mb-8"><div className="flex items-center space-x-4"><div className="flex-grow border-t border-gray-200"></div><h2 className="text-sm md:text-base font-bold text-gray-700 uppercase tracking-wide px-4 text-center">Responsables de la Plataforma y Soporte Técnico</h2><div className="flex-grow border-t border-gray-200"></div></div></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                                <ContactCard name="Ing. Dorian Escamilla Sauceda" position="Subdirector de Informática y Estadísticas en Salud" email="sub.informatica@slpsalud.gob.mx" initials="DE"/>
                                <ContactCard name="Fernando Montoya Rivera" position="Desarrollador de la Herramienta y Enlace de Información CLUES" email="clues.estadistica@slpsalud.gob.bx" initials="FM"/>
                            </div>
                        </div>
                    </footer>
                    {modalData && <ReportModal data={modalData} onClose={() => setModalData(null)} />}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
